<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>登録と紹介 - himegoto</title>
  <link rel="stylesheet" href="fix.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    /* reCAPTCHAエリアのスタイル */
    #recaptcha-container {
        min-height: 80px;
        margin: 15px 0;
        background: #f9f9f9;
        border: 1px dashed #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        text-align: center;
        padding: 10px;
    }
    /* エラーログ表示エリア */
    #debug-log {
        background: #333;
        color: #0f0;
        font-family: monospace;
        padding: 15px;
        margin-top: 30px;
        border-radius: 5px;
        font-size: 12px;
        display: none; /* エラー時のみ表示 */
        white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <!-- 共通ヘッダー読み込み -->
  <script src="header-loader.js"></script>

  <main class="container">
    <!-- 未認証時の画面 -->
    <section class="card" id="registration-section">
      <h2>アカウント登録</h2>
      
      <div id="paneSms">
        <p class="small muted">携帯番号によるSMS認証が必要です。</p>
        
        <div class="row">
          <input type="tel" id="phoneInput" placeholder="例：09012345678">
        </div>

        <!-- reCAPTCHA置き場 -->
        <div id="recaptcha-container">
            <span style="color:#666; font-size:12px;">
                読み込み中...<br>
                ここにチェックボックスが出ない場合は<br>
                再読み込みしてください
            </span>
        </div>

        <div class="row">
          <button class="btn" id="sendCodeSms" disabled>コード送信（チェック待ち）</button>
        </div>
        
        <div class="row">
          <input type="text" id="codeSms" placeholder="SMSで届いた6桁コード" disabled>
        </div>
        <div class="row">
          <input type="text" id="refCode" placeholder="紹介コード（任意）">
        </div>

        <!-- 規約リンク（復活） -->
        <div style="margin: 15px 0; font-size: 12px; color: #666;">
            登録することで、
            <a href="terms.html" target="_blank">利用規約</a>・
            <a href="privacy.html" target="_blank">プライバシーポリシー</a>
            に同意したものとみなされます。
        </div>

        <div class="row">
          <button class="btn primary" id="verifySms" disabled>同意して登録する</button>
        </div>
        
        <p id="smsMessage" class="small muted" style="margin-top: 10px; font-weight: bold;"></p>
      </div>
    </section>

    <!-- 認証済み画面 -->
    <section class="card" id="my-referral-section" style="display:none;">
      <h2>あなたの紹介ID</h2>
      <p class="small muted">このIDをお友達に伝えて登録してもらうと、特典が付与されます。</p>
      <div class="row">
        <input type="text" id="myRefId" readonly style="background:#eee; text-align: center; font-weight: bold; letter-spacing: 2px;">
      </div>
      <div class="row">
        <button class="btn" id="copyRefId">IDをコピー</button>
        <button class="btn primary" id="shareRefLink">紹介リンクを送る</button>
      </div>
    </section>

    <section class="card">
      <h2>注意事項</h2>
      <ul class="list">
        <li>無料版は顧客の登録数5名／1日の送信5回までです（日本時間0:00リセット）。</li>
        <li>バックアップはホームの「文字列を作る」で行えます。端末変更前に必ず保存してください。</li>
      </ul>
    </section>

    <!-- デバッグログ（エラー時のみ出現） -->
    <div id="debug-log"></div>
  </main>

  <!-- アプリロジック（Config含む） -->
  <script>
    // 1. ログ出力機能
    function log(msg) {
        const d = document.getElementById('debug-log');
        if(d) {
            d.style.display = 'block';
            d.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        }
        console.log(msg);
    }

    // 2. 画面メッセージ
    function showMessage(msg, isError) {
        const el = document.getElementById('smsMessage');
        if(el) {
            el.textContent = msg;
            el.style.color = isError ? 'red' : 'green';
        }
    }

    // 3. Firebase初期化
    const firebaseConfig = {
      apiKey: "AIzaSyD-gLP5rIErs678UewraA0vt59JbLZpzhU",
      authDomain: "himegoto-web.firebaseapp.com",
      projectId: "himegoto-web",
      storageBucket: "himegoto-web.firebasestorage.app",
      messagingSenderId: "368382081243",
      appId: "1:368382081243:web:09e3827701cbc6d1d2f4fe"
    };

    try {
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var db = firebase.firestore();
        auth.languageCode = 'ja';
        log("Firebase初期化成功");
    } catch(e) {
        log("Firebase初期化エラー: " + e.message);
    }

    // 4. アプリロジック
    document.addEventListener('DOMContentLoaded', () => {
        
        const sendBtn = document.getElementById('sendCodeSms');
        const verifyBtn = document.getElementById('verifySms');
        const phoneIn = document.getElementById('phoneInput');
        const codeIn = document.getElementById('codeSms');

        // reCAPTCHA初期化
        if (!window.recaptchaVerifier) {
            try {
                log("reCAPTCHA初期化開始...");
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'normal',
                    'callback': (response) => {
                        log("reCAPTCHA認証完了");
                        sendBtn.disabled = false;
                        sendBtn.textContent = "コード送信";
                        showMessage("認証されました。「コード送信」を押してください。", false);
                    },
                    'expired-callback': () => {
                        log("reCAPTCHA期限切れ");
                        sendBtn.disabled = true;
                        showMessage("期限切れです。チェックし直してください。", true);
                    }
                }, auth);

                window.recaptchaVerifier.render().then((widgetId) => {
                    log("reCAPTCHA描画成功 (ID: " + widgetId + ")");
                    window.recaptchaWidgetId = widgetId;
                }).catch((error) => {
                    log("【重要】reCAPTCHA描画エラー: " + error.code + "\n" + error.message);
                    if(error.message.includes("domain")) {
                        log("→ ドメイン許可設定が反映されていません。");
                    }
                });
            } catch(e) {
                log("reCAPTCHA設定例外: " + e.message);
            }
        }

        // 認証監視
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('registration-section').style.display = 'none';
                document.getElementById('my-referral-section').style.display = 'block';
                document.getElementById('myRefId').value = user.uid.substring(0, 8);
                log("ログイン済みユーザー: " + user.uid);
            } else {
                document.getElementById('registration-section').style.display = 'block';
                document.getElementById('my-referral-section').style.display = 'none';
            }
        });

        // 送信ボタン
        sendBtn.addEventListener('click', () => {
            const raw = phoneIn.value;
            let phone = raw.replace(/[━.*+]/g, '');
            if(phone.startsWith('0')) phone = '+81' + phone.substring(1);

            if(!window.recaptchaVerifier) {
                log("reCAPTCHA未準備");
                return;
            }

            sendBtn.disabled = true;
            showMessage("送信中...", false);
            
            auth.signInWithPhoneNumber(phone, window.recaptchaVerifier)
                .then((result) => {
                    window.confirmationResult = result;
                    log("SMS送信成功");
                    showMessage("送信成功！コードを入力してください。", false);
                    sendBtn.disabled = false;
                    sendBtn.textContent = "再送信";
                    codeIn.disabled = false;
                    verifyBtn.disabled = false;
                }).catch((error) => {
                    log("SMS送信エラー: " + error.code + " " + error.message);
                    showMessage("送信失敗: " + error.message, true);
                    sendBtn.disabled = false;
                });
        });

        // 登録ボタン
        verifyBtn.addEventListener('click', () => {
            const code = codeIn.value;
            if(!code || !window.confirmationResult) return;

            verifyBtn.disabled = true;
            showMessage("確認中...", false);

            window.confirmationResult.confirm(code).then((result) => {
                const user = result.user;
                log("認証成功: " + user.uid);
                
                // Firestore書き込み
                const refCode = document.getElementById('refCode').value;
                const p1 = db.collection('users').doc(user.uid).collection('purchases').doc('current').set({
                    expiresAt: null,
                    registeredAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                const p2 = db.collection('users').doc(user.uid).collection('profile').doc('info').set({
                    appliedRefCode: refCode
                }, { merge: true });

                Promise.all([p1, p2]).then(() => {
                    alert("登録完了！");
                    location.href = 'index.html';
                });
            }).catch((error) => {
                log("確認エラー: " + error.message);
                showMessage("コードが違います", true);
                verifyBtn.disabled = false;
            });
        });
        
        // コピーボタン
        document.getElementById('copyRefId').addEventListener('click', () => {
            document.getElementById('myRefId').select();
            document.execCommand('copy');
            alert('コピーしました');
        });
    });
  </script>
</body>
</html>

