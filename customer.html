<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>顧客情報メモ | himegoto</title>
  <link rel="icon" href="/icon-192.png">
  <link rel="stylesheet" href="/style.css">
  <style>
    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 16px; padding: 16px; box-shadow: 0 6px 24px rgba(0,0,0,.06); margin-top: 12px; }
    .row { display: grid; grid-template-columns: 140px 1fr; gap: 12px; align-items: center; margin: 10px 0; }
    .row textarea { min-height: 90px; }
    .actions { display:flex; gap:12px; justify-content: flex-end; margin-top: 12px; }
    .pill { padding: 2px 10px; border-radius: 999px; background: #ffe6f0; color:#d9387a; font-size: 12px; }
    .section-title { font-weight:700; margin-top: 4px; }
    .input, textarea, select { width:100%; }
  </style>
</head>
<body>
  <header class="header">
    <button class="hamburger" onclick="history.back()">戻る</button>
    <div class="brand">顧客情報メモ</div>
    <div class="spacer"></div>
    <div class="version">ver.1.30β</div>
  </header>

  <main class="container">
    <div class="card">
      <div><span class="pill" id="custNamePill"></span></div>

      <div class="section-title">基本情報</div>
      <div class="row">
        <label>呼び方</label>
        <input id="nickname" class="input" placeholder="例）山ちゃん / たかしさん">
      </div>
      <div class="row">
        <label>誕生日</label>
        <input id="birthday" class="input" type="date">
      </div>
      <div class="row">
        <label>タバコ</label>
        <div class="row">
  <label>タバコ</label>
  <input id="cigarette" class="input" placeholder="例）吸わない / セブンスター / IQOS / ビボラ">
        </div>
      </div>

      <div class="section-title">お酒</div>
      <div class="row">
        <label>キープ状況</label>
        <input id="bottle" class="input" placeholder="例）鏡月キープ / 山崎12年キープ">
      </div>
      <div class="row">
        <label>よく飲む</label>
        <input id="favorite" class="input" placeholder="例）ハイボール / 生ビール / シャンパン">
      </div>

      <div class="section-title">その他メモ</div>
      <div class="row">
        <label>メモ</label>
        <textarea id="memo" class="input" placeholder="仕事・好きな話題・来店頻度・NG話題など"></textarea>
      </div>

      <div class="actions">
        <button id="saveBtn" class="primary">保存</button>
        <button id="exportBtn" class="secondary">CSV保存</button>
      </div>

      <p style="font-size:12px;color:#666;margin-top:8px;">
        ※データは端末に保存されます（サーバー送信なし）。将来AI連携のためCSV形式で書き出し可。
      </p>
    </div>
  </main>

  <script>
    // ===== 顧客名取得 =====
    const params = new URLSearchParams(location.search);
    const name = params.get('name') || '';
    const pill  = document.getElementById('custNamePill');
    pill.textContent = name ? `顧客：${name}` : '顧客：未指定';

    // ===== localStorageキー =====
    const KEY = (n) => `memo_${n}`;

    // ===== 既存読込 =====
    function load() {
      try {
        const raw = localStorage.getItem(KEY(name));
        if (!raw) return;
        const data = JSON.parse(raw);
        for (const [k,v] of Object.entries(data)) {
          const el = document.getElementById(k);
          if (el) el.value = v ?? '';
        }
      } catch (e) { console.log(e); }
    }

    // ===== 保存 =====
    function save() {
      const data = {
        nickname: document.getElementById('nickname').value || '',
        birthday: document.getElementById('birthday').value || '',
        cigarette: document.getElementById('cigarette').value || '',
        bottle: document.getElementById('bottle').value || '',
        favorite: document.getElementById('favorite').value || '',
        memo: document.getElementById('memo').value || ''
      };
      localStorage.setItem(KEY(name), JSON.stringify(data));
      alert('保存しました（端末保存）');
    }

    // ===== CSV書き出し（端末内にデータURL） =====
    function exportCSV() {
      const raw = localStorage.getItem(KEY(name)) || '{}';
      const d = JSON.parse(raw);
      const headers = ['name','nickname','birthday','cigarette','bottle','favorite','memo'];
      const line = [
        name,
        d.nickname || '', d.birthday || '', d.cigarette || '',
        d.bottle || '', d.favorite || '', (d.memo || '').replace(/\n/g,'\\n')
      ].map(s => `"${String(s).replace(/"/g,'""')}"`).join(',');
      const csv = headers.join(',') + '\n' + line + '\n';
      const url = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      const a = document.createElement('a');
      a.href = url;
      a.download = `memo_${name || 'unknown'}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    document.getElementById('saveBtn').addEventListener('click', save);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    load();
  </script>
</body>
</html>
