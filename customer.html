<!doctype html>
<html lang="ja">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>顧客メモ - himegoto（β）</title><link rel="stylesheet" href="/style.css"></head>
<body>
<header class="header"><button class="hamburger" id="backBtn" aria-label="back">←</button>
  <div class="brand"><img src="/logo_himegoto.png" class="logo" alt="himegoto"></div>
  <div class="spacer"></div><div class="version">ver.1.30β</div>
</header>

<main class="container">
  <h1>顧客メモ</h1>
  <section class="card">
    <div class="row"><label style="width:120px">名前</label><input id="c_name" type="text" readonly></div>
    <div class="row"><label style="width:120px">呼び方</label><input id="c_nickname" type="text"></div>
    <div class="row"><label style="width:120px">誕生日</label><input id="c_birthday" type="date"></div>
    <div class="row"><label style="width:120px">タバコ</label>
      <select id="c_smoke">
        <option value="">未設定</option>
        <option value="吸わない">吸わない</option>
        <option value="メビウス">メビウス</option>
        <option value="セブンスター">セブンスター</option>
        <option value="その他">その他</option>
      </select>
    </div>
    <div class="row"><label style="width:120px">ボトル</label><input id="c_bottle" type="text" placeholder="キープ状況"></div>
    <div class="row"><label style="width:120px">よく飲む酒</label><input id="c_drink" type="text"></div>
    <div class="row"><label style="width:120px">その他</label><textarea id="c_memo" rows="5" placeholder="覚えておきたいこと"></textarea></div>
    <div class="row right">
      <button id="csv-btn" class="ghost">CSV更新</button>
      <button id="save-btn" class="primary">保存</button>
    </div>
    <p class="small muted">※すべて<strong>端末に保存</strong>。内部的にCSV文字列も保持し、将来AIから読み込みやすい形式にしています。</p>
  </section>
</main>

<script>
const qs=id=>document.getElementById(id);
const keyBase='hime_customers_v1';
const keyMemo='hime_customer_memo_v1';
const keyCSV='hime_customer_csv_v1';

const params=new URLSearchParams(location.search);
const name=params.get('name')||'';
qs('c_name').value=name;

const loadJSON=(k,def)=>{ try{ return JSON.parse(localStorage.getItem(k)||def);}catch{ return JSON.parse(def);} };

let memoMap=loadJSON(keyMemo,'{}');
const data=memoMap[name]||{nickname:'',birthday:'',smoke:'',bottle:'',drink:'',memo:''};

qs('c_nickname').value=data.nickname||'';
qs('c_birthday').value=data.birthday||'';
qs('c_smoke').value=data.smoke||'';
qs('c_bottle').value=data.bottle||'';
qs('c_drink').value=data.drink||'';
qs('c_memo').value=data.memo||'';

qs('save-btn').addEventListener('click',()=>{
  memoMap[name]={
    nickname:qs('c_nickname').value.trim(),
    birthday:qs('c_birthday').value,
    smoke:qs('c_smoke').value,
    bottle:qs('c_bottle').value.trim(),
    drink:qs('c_drink').value.trim(),
    memo:qs('c_memo').value.trim()
  };
  localStorage.setItem(keyMemo,JSON.stringify(memoMap));
  alert('保存しました');
});

function rebuildCSV(){
  const map=loadJSON(keyMemo,'{}');
  const headers=['name','nickname','birthday','smoke','bottle','drink','memo'];
  const rows=[headers.join(',')];
  Object.keys(map).forEach(n=>{
    const m=map[n]; const vals=[n,m.nickname||'',m.birthday||'',m.smoke||'',m.bottle||'',m.drink||'',(m.memo||'').replace(/\n/g,' ')];
    rows.push(vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
  });
  localStorage.setItem(keyCSV,rows.join('\n'));
}
qs('csv-btn').addEventListener('click',()=>{ rebuildCSV(); alert('CSVを更新しました'); });

document.getElementById('backBtn').addEventListener('click',()=>history.back());
</script>
</body>
</html>